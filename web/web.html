<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>预期寿命数据分析与管理系统</title>    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body {
            font-family: 'Inter', 'Helvetica Neue', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif;
        }
        .tab-button.active {
            border-color: #3b82f6;
            color: #3b82f6;
            background-color: #eff6ff;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .chart-container {
            position: relative;
            height: 450px;
            width: 100%;
        }
        .map-container {
            height: 500px;
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
        }
        .legend {
            line-height: 18px;
            color: #555;
            background: white;
            background: rgba(255,255,255,0.8);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
            padding: 6px 8px;
            font: 14px/16px Arial, Helvetica, sans-serif;
        }
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">预期寿命数据分析与管理系统</h1>
            <p class="text-md text-gray-500 mt-2">一个用于世界卫生组织(WHO)数据的交互式分析平台</p>
        </header>        <!-- Tabs Navigation -->
        <div class="mb-6 border-b border-gray-200">
            <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                <button onclick="changeTab('data-view')" class="tab-button active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600 hover:border-blue-300" data-tab="data-view">
                    数据视图
                </button>
                <button onclick="changeTab('analysis-view')" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600 hover:border-blue-300" data-tab="analysis-view">
                    可视化分析
                </button>
                <button onclick="changeTab('world-map')" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600 hover:border-blue-300" data-tab="world-map">
                    世界地图
                </button>
                <button onclick="changeTab('db-management')" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600 hover:border-blue-300" data-tab="db-management">
                    数据库管理
                </button>
            </nav>
        </div>

        <!-- Tab Content -->
        <div>
            <!-- Data View Tab -->
            <div id="data-view" class="tab-content active">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <h2 class="text-2xl font-semibold mb-4">数据浏览器</h2>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <input type="text" id="searchInput" class="col-span-1 md:col-span-2 p-2 border border-gray-300 rounded-lg" placeholder="在“国家”列中搜索...">
                        <button onclick="applyFilter()" class="col-span-1 bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600 transition">执行筛选</button>
                        <button onclick="exportToCSV()" class="col-span-1 bg-green-500 text-white p-2 rounded-lg hover:bg-green-600 transition">导出为 CSV</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr id="table-head"></tr>
                            </thead>
                            <tbody id="table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Data rows will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-4 flex justify-between items-center">
                        <button onclick="prevPage()" id="prevBtn" class="bg-gray-300 text-gray-700 p-2 rounded-lg hover:bg-gray-400 transition">&lt; 上一页</button>
                        <span id="pageInfo"></span>
                        <button onclick="nextPage()" id="nextBtn" class="bg-gray-300 text-gray-700 p-2 rounded-lg hover:bg-gray-400 transition">下一页 &gt;</button>
                    </div>
                </div>
            </div>

            <!-- Visual Analysis Tab -->
            <div id="analysis-view" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-sm">
                        <h2 class="text-2xl font-semibold mb-4">分析控制台</h2>
                        <div class="space-y-4">
                             <div>
                                <h3 class="font-medium mb-2">全局分析</h3>
                                <button onclick="showCorrelationHeatmap()" class="w-full bg-indigo-500 text-white p-2 rounded-lg hover:bg-indigo-600 transition">特征相关性热力图</button>
                            </div>
                            <div>
                                <h3 class="font-medium mb-2">多变量分析 (散点图)</h3>
                                <div class="grid grid-cols-2 gap-2">
                                    <select id="scatterX" class="p-2 border border-gray-300 rounded-lg"></select>
                                    <select id="scatterY" class="p-2 border border-gray-300 rounded-lg"></select>
                                </div>
                                <button onclick="showScatterPlot()" class="w-full mt-2 bg-indigo-500 text-white p-2 rounded-lg hover:bg-indigo-600 transition">生成散点图</button>
                            </div>
                             <div>
                                <h3 class="font-medium mb-2">专题分析</h3>
                                <select id="countrySelect" class="w-full p-2 border border-gray-300 rounded-lg mb-2"></select>
                                <button onclick="showCountryTrend()" class="w-full bg-indigo-500 text-white p-2 rounded-lg hover:bg-indigo-600 transition mb-2">显示该国预期寿命趋势</button>
                                <button onclick="showStatusComparison()" class="w-full bg-indigo-500 text-white p-2 rounded-lg hover:bg-indigo-600 transition">按“发展状况”对比</button>
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm">
                        <h2 id="chart-title" class="text-2xl font-semibold mb-4 text-center">分析结果</h2>
                        <div class="chart-container">
                            <canvas id="analysisChart"></canvas>
                        </div>
                    </div>                </div>
            </div>

            <!-- World Map Tab -->
            <div id="world-map" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-sm">
                        <h2 class="text-2xl font-semibold mb-4">地图控制台</h2>
                        <div class="space-y-4">
                            <div>
                                <h3 class="font-medium mb-2">选择特征</h3>
                                <select id="mapFeatureSelect" class="w-full p-2 border border-gray-300 rounded-lg">
                                    <option value="Life_expectancy">预期寿命</option>
                                    <option value="GDP">人均GDP</option>
                                    <option value="Adult_Mortality">成人死亡率</option>
                                    <option value="infant_deaths">婴儿死亡数</option>
                                    <option value="Alcohol">酒精消费量</option>
                                    <option value="BMI">平均BMI</option>
                                    <option value="Schooling">受教育年限</option>
                                    <option value="Population">人口</option>
                                </select>
                            </div>
                            <div>
                                <h3 class="font-medium mb-2">选择年份</h3>
                                <select id="mapYearSelect" class="w-full p-2 border border-gray-300 rounded-lg">
                                    <!-- 年份选项将通过JavaScript填充 -->
                                </select>
                            </div>
                            <div>
                                <h3 class="font-medium mb-2">颜色方案</h3>
                                <select id="colorSchemeSelect" class="w-full p-2 border border-gray-300 rounded-lg">
                                    <option value="blues">蓝色系</option>
                                    <option value="reds">红色系</option>
                                    <option value="greens">绿色系</option>
                                    <option value="oranges">橙色系</option>
                                    <option value="purples">紫色系</option>
                                </select>
                            </div>
                            <button onclick="updateWorldMap()" class="w-full bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600 transition">更新地图</button>
                            <div>
                                <h3 class="font-medium mb-2">统计信息</h3>
                                <div id="mapStats" class="text-sm text-gray-600 space-y-1">
                                    <p>选择特征以查看统计信息</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-3 bg-white p-6 rounded-xl shadow-sm">
                        <h2 id="map-title" class="text-2xl font-semibold mb-4 text-center">世界地图 - 特征分布</h2>
                        <div id="worldMap" class="map-container"></div>
                    </div>
                </div>
            </div>

            <!-- DB Management Tab -->
            <div id="db-management" class="tab-content">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h2 class="text-2xl font-semibold mb-4">记录管理 (增 / 改 / 查 / 删)</h2>
                        <div class="flex items-center gap-2 mb-4">
                            <input type="number" id="recordIdInput" placeholder="输入记录ID (例如 1)" class="w-full p-2 border border-gray-300 rounded-lg">
                            <button onclick="loadRecord()" class="bg-gray-500 text-white p-2 rounded-lg hover:bg-gray-600 transition whitespace-nowrap">加载记录</button>
                        </div>
                        <div id="recordForm" class="space-y-3"></div>
                        <div class="flex gap-4 mt-4">
                            <button onclick="updateRecord()" class="w-full bg-yellow-500 text-white p-2 rounded-lg hover:bg-yellow-600 transition">更新</button>
                            <button onclick="deleteRecord()" class="w-full bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 transition">删除</button>
                        </div>
                    </div>
                     <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h2 class="text-2xl font-semibold mb-4">添加与导入</h2>
                        <div class="mb-6">
                            <h3 class="font-medium mb-2">添加新记录</h3>
                            <div id="addRecordForm" class="space-y-3"></div>
                            <button onclick="addRecord()" class="w-full mt-4 bg-green-500 text-white p-2 rounded-lg hover:bg-green-600 transition">添加记录</button>
                        </div>
                        <div>
                             <h3 class="font-medium mb-2">批量导入</h3>
                             <p class="text-sm text-gray-500 mb-2">选择一个CSV文件批量导入数据。这会追加到现有数据末尾。</p>
                             <input type="file" id="csvFileInput" accept=".csv" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                             <button onclick="importFromCSV()" class="w-full mt-4 bg-purple-500 text-white p-2 rounded-lg hover:bg-purple-600 transition">开始导入</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>        // --- 全局变量和初始化 ---
        let originalData = [];
        let displayData = [];
        let headers = [];
        let numericHeaders = [];
        let currentPage = 1;
        const rowsPerPage = 15;
        let myChart;
        
        // 地图相关变量
        let worldMap = null;
        let mapData = {};
        let currentMapFeature = 'Life_expectancy';
        let currentMapYear = 2015;

        const CHINESE_HEADERS = {
            'Country': '国家', 'Year': '年份', 'Status': '发展状况', 'Life_expectancy': '预期寿命',
            'Adult_Mortality': '成人死亡率', 'infant_deaths': '婴儿死亡数', 'Alcohol': '酒精消费量',
            'percentage_expenditure': '人均卫生支出占比', 'Hepatitis_B': '乙肝疫苗接种率', 'Measles': '麻疹病例数',
            'BMI': '平均BMI', 'under-five_deaths': '五岁以下死亡数', 'Polio': '脊髓灰质炎疫苗接种率',
            'Total_expenditure': '卫生总支出占比', 'Diphtheria': '白喉疫苗接种率', 'HIV/AIDS': '艾滋病死亡率',
            'GDP': '人均GDP', 'Population': '人口', 'thinness__1-19_years': '10-19岁青少年消瘦率',
            'thinness_5-9_years': '5-9岁儿童消瘦率', 'Income_composition_of_resources': '人力资源收入构成指数', 'Schooling': '受教育年限'
        };        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const apiUrl = 'http://localhost:5000/api/data';
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`网络响应错误: ${response.status} ${response.statusText}`);
                }
                const data = await response.json();
                
                // 处理数据，将Status数值转换为文本
                const processedData = data.map(row => ({
                    ...row,
                    Status: row.Status === 1 ? 'Developed' : 'Developing'
                }));
                
                processData(processedData);
                initializeUI();
            } catch (error) {
                console.error('无法加载数据:', error);
                alert(`数据加载失败！\n错误详情: ${error.message}`);
            }
        });

        function cleanColumnName(name) {
            return name.trim().replace(/\s+/g, '_');
        }
          function processData(data) {
            // 数据已经是对象数组格式
            originalData = data;
            
            if (originalData.length === 0) {
                throw new Error("没有获取到任何有效数据，请检查API服务器。");
            }

            headers = Object.keys(originalData[0]);
            numericHeaders = headers.filter(h => {
                const sampleValue = originalData[0][h];
                return typeof sampleValue === 'number' && h !== 'Year' && h !== 'id';
            });
            displayData = [...originalData];
        }        function initializeUI() {
            renderTable();
            populateSelectors();
            renderRecordForm('recordForm');
            renderRecordForm('addRecordForm');
            initializeMapSelectors();
        }

        // --- Tab 切换逻辑 ---
        function changeTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
            
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`button[data-tab='${tabId}']`).classList.add('active');
            
            // 如果切换到世界地图标签页，初始化地图
            if (tabId === 'world-map' && !worldMap) {
                setTimeout(() => {
                    initializeWorldMap();
                }, 100);
            }
        }

        // --- 数据视图 (Data View) 逻辑 ---
        function renderTable() {
            const tableHead = document.getElementById('table-head');
            const tableBody = document.getElementById('table-body');
            
            tableHead.innerHTML = '<tr>' + headers.map(h => `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${CHINESE_HEADERS[h] || h}</th>`).join('') + '</tr>';
            
            tableBody.innerHTML = '';
            const pageData = displayData.slice((currentPage - 1) * rowsPerPage, currentPage * rowsPerPage);
            
            pageData.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = headers.map(h => `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${row[h] === undefined ? '' : row[h]}</td>`).join('');
                tableBody.appendChild(tr);
            });
            
            updatePagination();
        }

        function updatePagination() {
            const pageInfo = document.getElementById('pageInfo');
            const totalPages = Math.ceil(displayData.length / rowsPerPage);
            pageInfo.textContent = `第 ${currentPage} 页 / 共 ${totalPages} 页 (总计 ${displayData.length} 条记录)`;
            
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages || totalPages === 0;
        }

        function nextPage() {
            const totalPages = Math.ceil(displayData.length / rowsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderTable();
            }
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
        }
        
        function applyFilter() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if(searchTerm) {
                displayData = originalData.filter(row => row.Country && row.Country.toLowerCase().includes(searchTerm));
            } else {
                displayData = [...originalData];
            }
            currentPage = 1;
            renderTable();
        }

        function exportToCSV() {
            let csvContent = "data:text/csv;charset=utf-8," 
                + headers.join(',') + '\n' 
                + displayData.map(e => headers.map(h => {
                    let field = e[h] === undefined ? '' : e[h];
                    // Add quotes if the field contains a comma
                    if (typeof field === 'string' && field.includes(',')) {
                        return `"${field}"`;
                    }
                    return field;
                }).join(',')).join('\n');
            
            var encodedUri = encodeURI(csvContent);
            var link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "exported_data.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- 可视化分析 (Visual Analysis) 逻辑 ---
        function populateSelectors() {
            const countrySelect = document.getElementById('countrySelect');
            const scatterX = document.getElementById('scatterX');
            const scatterY = document.getElementById('scatterY');
            
            const countries = [...new Set(originalData.map(d => d.Country))].sort();
            countries.forEach(c => {
                const option = document.createElement('option');
                option.value = c;
                option.textContent = c;
                countrySelect.appendChild(option);
            });
            
            numericHeaders.forEach(h => {
                const optionX = document.createElement('option');
                optionX.value = h;
                optionX.textContent = CHINESE_HEADERS[h] || h;
                scatterX.appendChild(optionX);
                
                const optionY = document.createElement('option');
                optionY.value = h;
                optionY.textContent = CHINESE_HEADERS[h] || h;
                scatterY.appendChild(optionY);
            });
             scatterX.value = 'Schooling';
             scatterY.value = 'Life_expectancy';
        }

        function renderChart(config, title) {
            const ctx = document.getElementById('analysisChart').getContext('2d');
            document.getElementById('chart-title').textContent = title;
            if (myChart) {
                myChart.destroy();
            }
            myChart = new Chart(ctx, config);
        }

        function showCorrelationHeatmap() {
             const lifeCorr = numericHeaders.map(h => ({
                label: CHINESE_HEADERS[h] || h,
                value: getCorrelation('Life_expectancy', h)
            })).filter(c => c.label !== CHINESE_HEADERS['Life_expectancy']).sort((a,b) => Math.abs(b.value) - Math.abs(a.value));

            const barConfig = {
                type: 'bar',
                data: {
                    labels: lifeCorr.map(c => c.label),
                    datasets: [{
                        label: '与预期寿命的相关系数',
                        data: lifeCorr.map(c => c.value),
                        backgroundColor: lifeCorr.map(c => c.value > 0 ? 'rgba(54, 162, 235, 0.6)' : 'rgba(255, 99, 132, 0.6)'),
                    }]
                },
                options: { 
                    indexAxis: 'y',
                    scales: { 
                        x: { beginAtZero: false, title: { display: true, text: '皮尔逊相关系数' } } 
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            };
            renderChart(barConfig, '各关键特征与预期寿命的相关性');
        }
        
        function getCorrelation(var1, var2) {
            const data = originalData.map(d => ({ x: d[var1], y: d[var2] })).filter(p => typeof p.x === 'number' && typeof p.y === 'number');
            if (data.length < 2) return 0;
            
            let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0, sumY2 = 0;
            const n = data.length;
            for (const p of data) {
                sumX += p.x;
                sumY += p.y;
                sumXY += p.x * p.y;
                sumX2 += p.x * p.x;
                sumY2 += p.y * p.y;
            }
            const numerator = n * sumXY - sumX * sumY;
            const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
            if (denominator === 0) return 0;
            return numerator / denominator;
        }

        function showScatterPlot() {
            const xVar = document.getElementById('scatterX').value;
            const yVar = document.getElementById('scatterY').value;

            const data = originalData.map(d => ({ x: d[xVar], y: d[yVar] })).filter(p => typeof p.x === 'number' && typeof p.y === 'number');

            const config = {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: `${CHINESE_HEADERS[yVar]} vs ${CHINESE_HEADERS[xVar]}`,
                        data: data,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)'
                    }]
                },
                options: {
                    scales: {
                        x: { title: { display: true, text: CHINESE_HEADERS[xVar] || xVar } },
                        y: { title: { display: true, text: CHINESE_HEADERS[yVar] || yVar } }
                    }
                }
            };
            renderChart(config, `散点图: ${CHINESE_HEADERS[yVar]} vs ${CHINESE_HEADERS[xVar]}`);
        }

        function showCountryTrend() {
            const country = document.getElementById('countrySelect').value;
            const countryData = originalData.filter(d => d.Country === country).sort((a, b) => a.Year - b.Year);
            
            const config = {
                type: 'line',
                data: {
                    labels: countryData.map(d => d.Year),
                    datasets: [{
                        label: `预期寿命`,
                        data: countryData.map(d => d.Life_expectancy),
                        borderColor: 'rgba(75, 192, 192, 1)',
                        tension: 0.1,
                        fill: false,
                    }]
                },
                 options: {
                    scales: {
                        y: { title: { display: true, text: '预期寿命 (年)' } }
                    }
                }
            };
            renderChart(config, `${country} 预期寿命趋势 (2000-2015)`);
        }
        
        function showStatusComparison() {
            const developedData = originalData.filter(d => d.Status === 'Developed').map(d => d.Life_expectancy).filter(v => v);
            const developingData = originalData.filter(d => d.Status === 'Developing').map(d => d.Life_expectancy).filter(v => v);
            
            const avgDeveloped = developedData.reduce((a, b) => a + b, 0) / developedData.length;
            const avgDeveloping = developingData.reduce((a, b) => a + b, 0) / developingData.length;

            const config = {
                type: 'bar',
                data: {
                    labels: ['发达国家', '发展中国家'],
                    datasets: [{
                        label: '平均预期寿命',
                        data: [avgDeveloped, avgDeveloping],
                        backgroundColor: ['rgba(54, 162, 235, 0.6)', 'rgba(255, 159, 64, 0.6)']
                    }]
                },
                 options: {
                    scales: {
                        y: { title: { display: true, text: '平均预期寿命 (年)' } }
                    },
                    plugins: { legend: { display: false } }
                }
            };
            renderChart(config, '不同发展状况国家的平均预期寿命对比');
        }        // --- 数据库管理 (DB Management) 逻辑 ---
        async function reloadData() {
            try {
                const apiUrl = 'http://localhost:5000/api/data';
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`网络响应错误: ${response.status} ${response.statusText}`);
                }
                const data = await response.json();
                
                // 处理数据，将Status数值转换为文本
                const processedData = data.map(row => ({
                    ...row,
                    Status: row.Status === 1 ? 'Developed' : 'Developing'
                }));
                
                processData(processedData);
                renderTable();
                populateSelectors();
            } catch (error) {
                console.error('重新加载数据失败:', error);
                alert(`重新加载数据失败！\n错误详情: ${error.message}`);
            }
        }

        function renderRecordForm(formId) {
            const form = document.getElementById(formId);
            form.innerHTML = '';
            headers.filter(h => h !== 'id').forEach(h => {
                const label = document.createElement('label');
                label.textContent = CHINESE_HEADERS[h] || h;
                label.className = 'block text-sm font-medium text-gray-700';
                
                const input = document.createElement('input');
                input.type = (typeof originalData[0][h] === 'number' && h !== 'Year') ? 'number' : 'text';
                input.step = "any"; // Allow floating point numbers
                input.name = h;
                input.className = 'mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm';
                
                form.appendChild(label);
                form.appendChild(input);
            });
        }

        function loadRecord() {
            const id = parseInt(document.getElementById('recordIdInput').value);
            const record = originalData.find(d => d.id === id);
            
            if (record) {
                const form = document.getElementById('recordForm');
                headers.filter(h => h !== 'id').forEach(h => {
                    form.querySelector(`[name="${h}"]`).value = record[h] || '';
                });
            } else {
                alert('未找到该ID的记录！');
            }
        }

        async function updateRecord() {
            const id = parseInt(document.getElementById('recordIdInput').value);
            if (!id && id !== 0) {
                alert('请先加载一条记录！');
                return;
            }
            const form = document.getElementById('recordForm');            let updatedRecord = {};
            headers.filter(h => h !== 'id').forEach(h => {
                const input = form.querySelector(`[name="${h}"]`);
                let value = input.value;
                if (h === 'Status') {
                    // 将文本转换为数值
                    value = value.toLowerCase() === 'developed' ? 1 : 0;
                }
                updatedRecord[h] = value;
            });
            
            try {
                const res = await fetch(`http://localhost:5000/api/record/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(updatedRecord)
                });
                const result = await res.json();
                if(result.status === 'success') {
                    alert(`ID为 ${id} 的记录已更新。`);
                    await reloadData();
                } else {
                    alert('记录更新失败，未找到该ID！');
                }
            } catch (error) {
                alert(`记录更新失败：${error.message}`);
            }}
        
        async function addRecord() {
            const form = document.getElementById('addRecordForm');
            let newRecord = {};
            headers.filter(h => h !== 'id').forEach(h => {
                const input = form.querySelector(`[name="${h}"]`);
                let value = input.value;
                if (h === 'Status') {
                    // 将文本转换为数值
                    value = value.toLowerCase() === 'developed' ? 1 : 0;
                }
                newRecord[h] = value;
            });
            
            try {
                const res = await fetch('http://localhost:5000/api/record', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(newRecord)
                });
                const result = await res.json();
                if(result.status === 'success') {
                    alert('新记录已添加。');
                    await reloadData();
                    form.reset();
                } else {
                    alert('添加记录失败！');
                }
            } catch (error) {
                alert(`添加记录失败：${error.message}`);
            }
        }
        
        async function importFromCSV() {
            const fileInput = document.getElementById('csvFileInput');
            const file = fileInput.files[0];
            if (!file) {
                alert('请选择一个CSV文件！');
                return;
            }
            
            // 这里简化处理，实际项目中可能需要更复杂的CSV解析
            alert('CSV导入功能需要后端支持，当前版本暂不支持。');
        }
        
        async function deleteRecord() {
            const id = parseInt(document.getElementById('recordIdInput').value);
            if (!id && id !== 0) {
                alert('请先加载一条记录！');
                return;
            }
            if (confirm(`您确定要删除ID为 ${id} 的记录吗？此操作无法撤销。`)) {
                const res = await fetch(`http://localhost:5000/api/record/${id}`, {
                    method: 'DELETE'
                });
                const result = await res.json();
                if(result.status === 'success') {
                    await reloadData();
                    document.getElementById('recordForm').reset();
                    document.getElementById('recordIdInput').value = '';
                    alert(`ID为 ${id} 的记录已删除。`);
                } else {
                    alert('记录删除失败，未找到该ID！');
                }            }
        }

        // --- 世界地图功能 ---        // 国家名称映射 (数据库中的名称到GeoJSON中的名称)
        const COUNTRY_NAME_MAPPING = {
            'United States of America': 'United States of America',
            'United Kingdom of Great Britain and Northern Ireland': 'United Kingdom',
            'Russian Federation': 'Russia',
            'Republic of Korea': 'South Korea',
            'Democratic People\'s Republic of Korea': 'North Korea',
            'Iran (Islamic Republic of)': 'Iran',
            'Venezuela (Bolivarian Republic of)': 'Venezuela',
            'United Republic of Tanzania': 'Tanzania',
            'Democratic Republic of the Congo': 'Democratic Republic of the Congo',
            'Libyan Arab Jamahiriya': 'Libya',
            'The former Yugoslav Republic of Macedonia': 'Macedonia',
            'Republic of Moldova': 'Moldova',
            'Syrian Arab Republic': 'Syria',
            'Bolivia (Plurinational State of)': 'Bolivia',
            'Lao People\'s Democratic Republic': 'Laos',
            'Brunei Darussalam': 'Brunei',
            'Cabo Verde': 'Cape Verde',
            'Côte d\'Ivoire': 'Ivory Coast',
            'Czechia': 'Czech Republic',
            'Republic of the Congo': 'Republic of the Congo',
            'Central African Republic': 'Central African Republic',
            'Micronesia (Federated States of)': 'Federated States of Micronesia',
            'Viet Nam': 'Vietnam',
            'Republic of South Sudan': 'South Sudan',
            'China': 'China',
            'India': 'India',
            'Brazil': 'Brazil',
            'Germany': 'Germany',
            'France': 'France',
            'Italy': 'Italy',
            'Spain': 'Spain',
            'Japan': 'Japan',
            'Canada': 'Canada',
            'Australia': 'Australia',
            'Egypt': 'Egypt',
            'South Africa': 'South Africa',
            'Nigeria': 'Nigeria',
            'Kenya': 'Kenya',
            'Ethiopia': 'Ethiopia',
            'Ghana': 'Ghana',
            'Morocco': 'Morocco',
            'Algeria': 'Algeria',
            'Tunisia': 'Tunisia',
            'Sudan': 'Sudan',
            'Uganda': 'Uganda',
            'Zambia': 'Zambia',
            'Zimbabwe': 'Zimbabwe',
            'Botswana': 'Botswana',
            'Namibia': 'Namibia',
            'Madagascar': 'Madagascar',
            'Malawi': 'Malawi',
            'Mozambique': 'Mozambique',
            'Rwanda': 'Rwanda',
            'Angola': 'Angola',
            'Cameroon': 'Cameroon',
            'Chad': 'Chad',
            'Mali': 'Mali',
            'Niger': 'Niger',
            'Burkina Faso': 'Burkina Faso',
            'Senegal': 'Senegal',
            'Guinea': 'Guinea',
            'Sierra Leone': 'Sierra Leone',
            'Liberia': 'Liberia',
            'Benin': 'Benin',
            'Togo': 'Togo',
            'Gabon': 'Gabon',
            'Equatorial Guinea': 'Equatorial Guinea',
            'Sao Tome and Principe': 'São Tomé and Príncipe',
            'Comoros': 'Comoros',
            'Mauritius': 'Mauritius',
            'Seychelles': 'Seychelles',
            'Djibouti': 'Djibouti',
            'Eritrea': 'Eritrea',
            'Somalia': 'Somalia'
        };

        function initializeMapSelectors() {
            // 填充年份选择器
            const yearSelect = document.getElementById('mapYearSelect');
            const years = [...new Set(originalData.map(d => d.Year))].sort();
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === 2015) option.selected = true;
                yearSelect.appendChild(option);
            });
        }

        function initializeWorldMap() {
            if (worldMap) {
                worldMap.remove();
            }
            
            // 初始化地图
            worldMap = L.map('worldMap').setView([20, 0], 2);
            
            // 添加地图瓷砖层
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(worldMap);
            
            // 加载并显示初始数据
            updateWorldMap();
        }        function getColorScheme(scheme, value, min, max) {
            // 处理边界情况
            if (max === min) {
                return 'rgb(200, 200, 200)'; // 如果所有值相同，返回灰色
            }
            
            const ratio = Math.max(0, Math.min(1, (value - min) / (max - min))); // 确保ratio在0-1之间
            
            const colors = {
                'blues': [
                    [247, 251, 255],
                    [222, 235, 247],
                    [198, 219, 239],
                    [158, 202, 225],
                    [107, 174, 214],
                    [66, 146, 198],
                    [33, 113, 181],
                    [8, 81, 156],
                    [8, 48, 107]
                ],
                'reds': [
                    [255, 245, 240],
                    [254, 224, 210],
                    [252, 187, 161],
                    [252, 146, 114],
                    [251, 106, 74],
                    [239, 59, 44],
                    [203, 24, 29],
                    [165, 15, 21],
                    [103, 0, 13]
                ],
                'greens': [
                    [247, 252, 245],
                    [229, 245, 224],
                    [199, 233, 192],
                    [161, 217, 155],
                    [116, 196, 118],
                    [65, 171, 93],
                    [35, 139, 69],
                    [0, 109, 44],
                    [0, 68, 27]
                ],
                'oranges': [
                    [255, 245, 235],
                    [254, 230, 206],
                    [253, 208, 162],
                    [253, 174, 107],
                    [253, 141, 60],
                    [241, 105, 19],
                    [217, 72, 1],
                    [166, 54, 3],
                    [127, 39, 4]
                ],
                'purples': [
                    [252, 251, 253],
                    [239, 237, 245],
                    [218, 218, 235],
                    [188, 189, 220],
                    [158, 154, 200],
                    [128, 125, 186],
                    [106, 81, 163],
                    [84, 39, 143],
                    [63, 0, 125]
                ]
            };
            
            const colorArray = colors[scheme] || colors['blues'];
            const index = Math.floor(ratio * (colorArray.length - 1));
            const color = colorArray[Math.min(index, colorArray.length - 1)];
            return `rgb(${color[0]}, ${color[1]}, ${color[2]})`;
        }

        function updateWorldMap() {
            if (!worldMap) return;
            
            const feature = document.getElementById('mapFeatureSelect').value;
            const year = parseInt(document.getElementById('mapYearSelect').value);
            const colorScheme = document.getElementById('colorSchemeSelect').value;
            
            currentMapFeature = feature;
            currentMapYear = year;
            
            // 过滤指定年份的数据
            const yearData = originalData.filter(d => d.Year === year);
            
            // 计算统计信息
            const values = yearData.map(d => d[feature]).filter(v => v !== null && v !== undefined && !isNaN(v));
            const min = Math.min(...values);
            const max = Math.max(...values);
            const avg = values.reduce((a, b) => a + b, 0) / values.length;
            
            // 更新统计信息显示
            document.getElementById('mapStats').innerHTML = `
                <p><strong>特征:</strong> ${CHINESE_HEADERS[feature] || feature}</p>
                <p><strong>年份:</strong> ${year}</p>
                <p><strong>最小值:</strong> ${min.toFixed(2)}</p>
                <p><strong>最大值:</strong> ${max.toFixed(2)}</p>
                <p><strong>平均值:</strong> ${avg.toFixed(2)}</p>
                <p><strong>数据点数:</strong> ${values.length}</p>
            `;
            
            // 更新地图标题
            document.getElementById('map-title').textContent = `世界地图 - ${CHINESE_HEADERS[feature] || feature}分布 (${year}年)`;            // 创建国家数据映射
            const countryData = {};
            
            // 首先直接使用原始国家名称
            yearData.forEach(d => {
                const countryName = d.Country;
                const value = d[feature];
                // 确保国家名称和值都有效
                if (countryName && typeof countryName === 'string' && 
                    value !== null && value !== undefined && !isNaN(value)) {
                    countryData[countryName] = parseFloat(value);
                }
            });
            
            console.log('Original country data:', Object.keys(countryData).slice(0, 10)); // 调试信息
            console.log('Min:', min, 'Max:', max, 'Feature:', feature); // 调试信息
            
            // 清除现有图层
            worldMap.eachLayer(layer => {
                if (layer !== worldMap._layers[Object.keys(worldMap._layers)[0]]) {
                    worldMap.removeLayer(layer);
                }
            });
              // 加载世界国家边界数据并应用颜色
            fetch('https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson')
                .then(response => response.json())
                .then(data => {                    L.geoJSON(data, {                        style: (feature) => {
                            const geoCountryName = feature.properties.NAME;
                            let value = countryData[geoCountryName];
                            
                            // 如果直接匹配失败，尝试使用映射
                            if (value === undefined) {
                                // 尝试反向映射
                                for (const [dataName, geoName] of Object.entries(COUNTRY_NAME_MAPPING)) {
                                    if (geoName === geoCountryName && countryData[dataName]) {
                                        value = countryData[dataName];
                                        break;
                                    }
                                }
                                
                                // 如果还是没找到，尝试部分匹配
                                if (value === undefined) {
                                    for (const [dataCountry, dataValue] of Object.entries(countryData)) {
                                        // 确保dataCountry和geoCountryName都是字符串且不为空
                                        if (dataCountry && geoCountryName && 
                                            typeof dataCountry === 'string' && 
                                            typeof geoCountryName === 'string') {
                                            if (dataCountry.includes(geoCountryName) || geoCountryName.includes(dataCountry)) {
                                                value = dataValue;
                                                break;
                                            }
                                        }
                                    }
                                }
                            }
                            
                            if (value !== undefined && value !== null && !isNaN(value)) {
                                const color = getColorScheme(colorScheme, value, min, max);
                                return {
                                    fillColor: color,
                                    weight: 1,
                                    opacity: 1,
                                    color: '#666',
                                    fillOpacity: 0.8
                                };
                            } else {
                                return {
                                    fillColor: '#f0f0f0',
                                    weight: 1,
                                    opacity: 1,
                                    color: '#999',
                                    fillOpacity: 0.4
                                };
                            }
                        },                        onEachFeature: (feature, layer) => {
                            const geoCountryName = feature.properties.NAME;
                            let value = countryData[geoCountryName];
                            
                            // 使用相同的匹配逻辑
                            if (value === undefined) {
                                for (const [dataName, geoName] of Object.entries(COUNTRY_NAME_MAPPING)) {
                                    if (geoName === geoCountryName && countryData[dataName]) {
                                        value = countryData[dataName];
                                        break;
                                    }
                                }
                                
                                if (value === undefined) {
                                    for (const [dataCountry, dataValue] of Object.entries(countryData)) {
                                        // 确保dataCountry和geoCountryName都是字符串且不为空
                                        if (dataCountry && geoCountryName && 
                                            typeof dataCountry === 'string' && 
                                            typeof geoCountryName === 'string') {
                                            if (dataCountry.includes(geoCountryName) || geoCountryName.includes(dataCountry)) {
                                                value = dataValue;
                                                break;
                                            }
                                        }
                                    }
                                }
                            }
                            
                            let popupContent = `
                                <div>
                                    <h3><strong>${geoCountryName}</strong></h3>
                                    <p><strong>${CHINESE_HEADERS[currentMapFeature] || currentMapFeature}:</strong> 
                                    ${value !== undefined && value !== null && !isNaN(value) ? value.toFixed(2) : '暂无数据'}</p>
                                    <p><strong>年份:</strong> ${currentMapYear}</p>
                                </div>
                            `;
                            
                            layer.bindPopup(popupContent);
                            
                            layer.on({
                                mouseover: (e) => {
                                    const layer = e.target;
                                    layer.setStyle({
                                        weight: 3,
                                        color: '#000',
                                        fillOpacity: 0.9
                                    });
                                },
                                mouseout: (e) => {
                                    const layer = e.target;
                                    if (value !== undefined && value !== null && !isNaN(value)) {
                                        layer.setStyle({
                                            weight: 1,
                                            color: '#666',
                                            fillOpacity: 0.8
                                        });
                                    } else {
                                        layer.setStyle({
                                            weight: 1,
                                            color: '#999',
                                            fillOpacity: 0.4
                                        });
                                    }
                                }
                            });
                        }
                    }).addTo(worldMap);
                    
                    // 添加图例
                    addMapLegend(min, max, colorScheme);
                })
                .catch(error => {
                    console.error('加载地图数据失败:', error);
                    alert('加载地图数据失败，请检查网络连接');
                });
        }

        function addMapLegend(min, max, colorScheme) {
            // 移除现有图例
            const existingLegend = document.querySelector('.legend');
            if (existingLegend) {
                existingLegend.remove();
            }
            
            const legend = L.control({position: 'bottomright'});
            
            legend.onAdd = function (map) {
                const div = L.DomUtil.create('div', 'legend');
                const grades = [];
                const step = (max - min) / 8;
                
                for (let i = 0; i < 9; i++) {
                    grades.push(min + step * i);
                }
                
                div.innerHTML += `<h4>${CHINESE_HEADERS[currentMapFeature] || currentMapFeature}</h4>`;
                
                for (let i = 0; i < grades.length - 1; i++) {
                    const color = getColorScheme(colorScheme, grades[i], min, max);
                    div.innerHTML +=
                        `<i style="background:${color}"></i> ` +
                        `${grades[i].toFixed(1)}&ndash;${grades[i + 1].toFixed(1)}<br>`;
                }
                
                return div;
            };
            
            legend.addTo(worldMap);
        }
    </script>

</body>
</html>
